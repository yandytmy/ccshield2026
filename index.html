<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”è³½å ±åˆ°æ ¸å°ç³»çµ± v2</title>
<style>
  :root { --primary: #1E88E5; --success: #43A047; --bg: #f4f4f4; --dark: #333; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; }
  header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
  .container { padding: 15px; max-width: 600px; margin: auto; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  /* Input & Select */
  input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
  
  /* Member Info Table */
  .member-row { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
  .member-name { font-weight: bold; color: var(--primary); font-size: 18px; }
  .member-detail { font-size: 14px; color: #666; }

  /* Checklist Style */
  .checklist-box { background: #fffbe6; padding: 10px; border-radius: 8px; border: 1px solid #ffe58f; }
  .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; cursor: pointer; }
  .check-item:last-child { border-bottom: none; }
  input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; }
  
  .select-all-btn { background: #eee; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; cursor: pointer; }
  
  button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  .hidden { display: none; }
</style>
</head>
<body>

<header>ğŸ“‹ å¹¼ç«¥è»æ¯”è³½å ±åˆ°ç³»çµ±</header>

<div class="container">
  <div id="step1" class="card">
    <h3>å·¥ä½œäººå“¡ç™»å…¥</h3>
    <input type="text" id="staffName" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
    <button class="btn-primary" onclick="goStep2()">é€²å…¥å ±åˆ°ç¨‹åº</button>
  </div>

  <div id="step2" class="card hidden">
    <h3>è­˜åˆ¥éšŠä¼</h3>
    <input type="number" id="teamNo" placeholder="è«‹è¼¸å…¥éšŠè™Ÿ (01-27)" min="1" max="27">
    <button class="btn-primary" onclick="loadTeamData()">æœå°‹éšŠä¼</button>
    <button style="background:#888; color:white;" onclick="location.reload()">è¿”å›ç™»å…¥</button>
  </div>

  <div id="step3" class="card hidden">
    <h2 id="displayTeamTitle">éšŠä¼ 01 å ±åˆ°æ¸…å–®</h2>
    <div id="memberListContainer">
        </div>
    
    <hr>
    <textarea id="remarkG" placeholder="G. é•è¦ç‹€æ³å‚™è¨» (å¦‚ï¼šé ˜å·¾é¡è‰²ã€é‹å…·ä¸ç¬¦)"></textarea>
    <button class="btn-success" onclick="finalSubmit()">ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™</button>
  </div>

  <div id="step4" class="card hidden" style="text-align: center;">
    <h2 style="color:var(--success)">âœ… å ±åˆ°å·²æäº¤</h2>
    <p>è©²éšŠè³‡æ–™å·²æˆåŠŸå‚³é€åˆ° Google Sheetã€‚</p>
    <button class="btn-primary" onclick="resetToTeamSelection()">è™•ç†ä¸‹ä¸€éšŠ</button>
  </div>
</div>

<script>
// ========== 1. è³‡æ–™åº« (é€™éƒ¨åˆ†å»ºè­°å¾ Google Sheet è½‰ç‚º JSON è²¼ä¸Š) ==========
const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbyqgap791bh5UI5NuPYK7nA86posKZIGBKESWSc-mv3A6XKnlDzgFY4xK_ZgbN5NkA/exec";

// ========== 2. Google Form è¨­å®š ==========
const FORM_URL = "https://docs.google.com/forms/d/e/æ‚¨çš„ID/formResponse";
const ENTRIES = {
    staff: "entry.111111",
    teamId: "entry.222222",
    result: "entry.333333", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    note: "entry.444444"
};

let remoteTeamData = null; // ç”¨ä¾†å„²å­˜å¾ç¶²è·¯ä¸ŠæŠ“åˆ°çš„è³‡æ–™
let currentStaff = "";

// ç¶²é é–‹å•Ÿæ™‚ï¼Œè‡ªå‹•å»æŠ“åå–®
window.onload = function() {
    fetch(SCRIPT_API_URL)
        .then(res => res.json())
        .then(data => {
            remoteTeamData = data;
            console.log("è³‡æ–™åŠ è¼‰å®Œæˆ", data);
        })
        .catch(err => alert("ç„¡æ³•è¼‰å…¥åå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š"));
};

function goStep2() {
    currentStaff = document.getElementById('staffName').value.trim();
    if (!currentStaff) return alert("è«‹è¼¸å…¥å·¥ä½œäººå“¡åç¨±");
    if (!remoteTeamData) return alert("åå–®ä»åœ¨è®€å–ä¸­ï¼Œè«‹ç¨å€™...");
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}

function loadTeamData() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    
    // å¾é ç«¯è³‡æ–™ä¸­æ‰¾å°æ‡‰éšŠä¼
    const members = remoteTeamData[teamKey];

    if (!members) return alert("æ‰¾ä¸åˆ°è©²éšŠä¼è³‡æ–™ï¼Œè«‹æª¢æŸ¥éšŠè™Ÿ (01-27)");

    document.getElementById('displayTeamTitle').innerText = "éšŠä¼ " + teamKey + " å ±åˆ°æ ¸å°";
    const container = document.getElementById('memberListContainer');
    container.innerHTML = ""; 

    members.forEach((m) => {
        const mDiv = document.createElement('div');
        mDiv.className = "member-row";
        mDiv.innerHTML = `
            <div class="member-name">${m.mem}. ${m.cn} (${m.en})</div>
            <div class="member-detail">å‡ºç”Ÿæ—¥æœŸ: ${m.dob}</div>
            <br>
            <div class="checklist-box">
                <div class="select-all-btn" onclick="selectAll('${m.mem}')">âœ… ä¸€éµå…¨é¸ (A-F)</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="A"> A. èº«ä»½è­‰æ˜æ–‡ä»¶</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="B"> B. å¹¼ç«¥è»ç´€éŒ„å†Š</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="C"> C. æœ‰æ•ˆç´€éŒ„å†Š(å°ç« )</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="D"> D. æœ‰æ•ˆæœƒå“¡è³‡æ ¼</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="E"> E. å§“åç›¸ç¬¦</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="F"> F. ç©¿ç€æ•´é½Šåˆ¶æœ</div>
            </div>
        `;
        container.appendChild(mDiv);
    });

    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

function selectAll(memCode) {
    const checkboxes = document.querySelectorAll(`.cb_${memCode}`);
    checkboxes.forEach(cb => cb.checked = true);
}

function finalSubmit() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey]; // ä¿®æ­£ï¼šå¾ remoteTeamData è®€å–
    let allResults = "";

    members.forEach(m => {
        const checked = Array.from(document.querySelectorAll(`.cb_${m.mem}:checked`))
                             .map(cb => cb.getAttribute('data-code'))
                             .join('');
        allResults += `[${m.mem}:${checked || 'FAIL'}] `;
    });

    const note = document.getElementById('remarkG').value;

    const formData = new FormData();
    formData.append(ENTRIES.staff, currentStaff);
    formData.append(ENTRIES.teamId, teamKey);
    formData.append(ENTRIES.result, allResults);
    formData.append(ENTRIES.note, note);

    fetch(FORM_URL, { method: "POST", mode: "no-cors", body: formData })
    .then(() => {
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.remove('hidden');
        window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨çœ‹åˆ°æˆåŠŸè¨Šæ¯
    })
    .catch(err => alert("æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"));
}

function resetToTeamSelection() {
    document.getElementById('teamNo').value = "";
    document.getElementById('remarkG').value = "";
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}
</script>
</body>
</html>