<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CC Shield Registration System 2026</title>
<style>
  /* --- é¡è‰²èˆ‡åŸºç¤è¨­å®š --- */
  :root { --primary: #1E88E5; --success: #43A047; --bg: #f4f4f4; --dark: #333; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; }
  header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
  .container { padding: 15px; max-width: 600px; margin: auto; }
  
  /* --- å¡ç‰‡èˆ‡ä½ˆå±€ --- */
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .hidden { display: none; }
  
  /* --- è¡¨å–®å…ƒä»¶ --- */
  input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
  textarea { height: 80px; resize: none; font-size: 14px; background: #fff; }
  
  /* --- è³½å“¡åˆ—æ¨£å¼ --- */
  .member-row { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
  .member-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
  .member-info-text { font-weight: bold; color: var(--primary); font-size: 16px; flex: 1; line-height: 1.4; }
  .member-icon { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd; background: #eee; }

  /* --- æª¢æŸ¥æ¸…å–®é …ç›® --- */
  .checklist-box { background: #fffbe6; padding: 10px; border-radius: 8px; border: 1px solid #ffe58f; }
  .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
  .check-item:last-child { border-bottom: none; }
  input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; flex-shrink: 0; }
  
  /* --- æŒ‰éˆ•æ¨£å¼ --- */
  .select-all-btn { background: #eee; border: 1px solid #ccc; padding: 8px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; cursor: pointer; text-align: center; font-weight: bold; }
  button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.3s; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  button:disabled { background: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<header>ğŸ“‹ 2026å¹´é¦™æ¸¯ç¸½ç›£æŒ‘æˆ°ç›¾ç¸½æ±ºè³½ å ±åˆ°ç³»çµ±</header>

<div class="container">
  <div id="step1" class="card">
    <h3>å·¥ä½œäººå“¡ç™»å…¥</h3>
    <input type="text" id="staffName" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
    <button class="btn-primary" onclick="goStep2()">é€²å…¥å ±åˆ°ç¨‹åº</button>
  </div>

  <div id="step2" class="card hidden">
    <h3>è­˜åˆ¥éšŠä¼</h3>
    <input type="number" id="teamNo" placeholder="è«‹è¼¸å…¥éšŠè™Ÿ (01-26)" min="1" max="26">
    <button class="btn-primary" onclick="loadTeamData()">æœå°‹éšŠä¼</button>
    <button style="background:#888; color:white;" onclick="location.reload()">è¿”å›ç™»å…¥</button>
  </div>

  <div id="step3" class="card hidden">
    <h2 id="displayTeamTitle">éšŠä¼ 01 å ±åˆ°æ ¸å°</h2>
    <div id="memberListContainer"></div>
    <hr>
    <button class="btn-success" id="finalSubmitBtn" onclick="finalSubmit()">ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™</button>
  </div>

  <div id="step4" class="card hidden" style="text-align: center;">
    <h2 style="color:var(--success)">âœ… å ±åˆ°å·²æäº¤</h2>
    <p>è©²éšŠè³‡æ–™å·²æˆåŠŸå‚³é€åˆ° Google Sheetã€‚</p>
    <button class="btn-primary" onclick="resetToTeamSelection()">è™•ç†ä¸‹ä¸€éšŠ</button>
  </div>
</div>

<script>
// ========== [è¨­å®šå€] ==========
const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbxMApvuoj4g7zNEdPQOk_-ro6OLOxrvhk_VNyCOMnUr24i9qui7LOSaFSBtfCJevR8o/exec";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeR5ESTo7IWleRlI5KDEBnhI3xJpwR0hTkOWKMKe9tFcM9kSQ/formResponse";

const ENTRIES = {
    staff: "entry.1007120810",
    teamId: "entry.1465479015",
    memId: "entry.1426192719",
    resultA: "entry.1833090949",
    resultB: "entry.1695763412",
    resultC: "entry.1961756043",
    resultD: "entry.466169006",
    resultE: "entry.343479111",
    resultF: "entry.2039460295",
    note: "entry.1273670747"
};

let remoteTeamData = null; 
let currentStaff = "";

// [åˆå§‹åŒ–] æŠ“å–åå–®
window.onload = function() {
    fetch(SCRIPT_API_URL)
        .then(res => res.json())
        .then(data => { remoteTeamData = data; console.log("åå–®è¼‰å…¥æˆåŠŸ"); })
        .catch(err => alert("ç„¡æ³•è¼‰å…¥åå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"));
};

// [æ­¥é©Ÿåˆ‡æ›] ç™»å…¥ -> éšŠè™Ÿ
function goStep2() {
    currentStaff = document.getElementById('staffName').value.trim();
    if (!currentStaff) return alert("è«‹è¼¸å…¥å·¥ä½œäººå“¡åç¨±");
    if (!remoteTeamData) return alert("è³‡æ–™è¼‰å…¥ä¸­...");
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}

// [åŠŸèƒ½] è¼‰å…¥åå–®ä¸¦é‚„åŸæš«å­˜
function loadTeamData() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey];

    if (!members) return alert("æ‰¾ä¸åˆ°éšŠä¼");

    document.getElementById('displayTeamTitle').innerText = "éšŠä¼ " + teamKey + " å ±åˆ°æ ¸å°";
    const container = document.getElementById('memberListContainer');
    container.innerHTML = ""; 

    members.forEach((m) => {
        let iconUrl = m.icon || "";
        if (iconUrl.includes("drive.google.com")) {
            const fileId = iconUrl.split('/d/')[1]?.split('/')[0];
            iconUrl = `https://lh3.googleusercontent.com/d/${fileId}`;
        }

        const mDiv = document.createElement('div');
        mDiv.className = "member-row";
        mDiv.innerHTML = `
            <div class="member-header">
                <div class="member-info-text">${m.mem}. ${m.cn} (${m.en})<br>å‡ºç”Ÿæ—¥æœŸ: ${m.dob}</div>
                <img src="${iconUrl}" class="member-icon" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
            </div>
            <div class="checklist-box">
                <div class="select-all-btn" onclick="selectAll('${m.mem}', '${teamKey}')">âœ… ä¸€éµå…¨é¸ (A-F)</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="A" onchange="saveProgress('${teamKey}')"> 1. èº«ä»½è­‰æ˜æ–‡ä»¶</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="B" onchange="saveProgress('${teamKey}')"> 2. å¹¼ç«¥è»ç´€éŒ„å†Š</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="C" onchange="saveProgress('${teamKey}')"> 3. æœ‰æ•ˆç´€éŒ„å†Š(å°ç« )</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="D" onchange="saveProgress('${teamKey}')"> 4. æœ‰æ•ˆæœƒå“¡è³‡æ ¼(å·²çºŒè­‰)</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="E" onchange="saveProgress('${teamKey}')"> 5. ä¸­è‹±æ–‡å§“åã€ç›¸ç‰‡ç›¸ç¬¦</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="F" onchange="saveProgress('${teamKey}')"> 6. ç©¿ç€æ•´é½Šåˆ¶æœ(é¡è‰²è† å·¾åœˆã€é»‘è‰²ç¶å¸¶çš®é‹ç­‰)</div>
                <textarea id="note_${m.mem}" oninput="saveProgress('${teamKey}')" placeholder="7. é•è¦ç‹€æ³å‚™è¨»(å¦‚ï¼šæˆ´å°ç‹¼é ­ã€ç™½è¥ªã€ä¸æ˜¯ç¶å¸¶é»‘çš®é‹)"></textarea>
            </div>
        `;
        container.appendChild(mDiv);
    });

    restoreProgress(teamKey); // è¼‰å…¥å¾Œè‡ªå‹•é‚„åŸæš«å­˜
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

// [æš«å­˜åŠŸèƒ½] å„²å­˜åˆ° localStorage
function saveProgress(teamKey) {
    const members = remoteTeamData[teamKey];
    const draft = {};
    members.forEach(m => {
        draft[m.mem] = {
            checks: ['A','B','C','D','E','F'].map(c => document.querySelector(`.cb_${m.mem}[data-code="${c}"]`).checked),
            note: document.getElementById(`note_${m.mem}`).value
        };
    });
    localStorage.setItem(`draft_${teamKey}`, JSON.stringify(draft));
}

// [æš«å­˜åŠŸèƒ½] å¾ localStorage é‚„åŸ
function restoreProgress(teamKey) {
    const data = localStorage.getItem(`draft_${teamKey}`);
    if (!data) return;
    const draft = JSON.parse(data);
    Object.keys(draft).forEach(memId => {
        const mDraft = draft[memId];
        ['A','B','C','D','E','F'].forEach((c, idx) => {
            const cb = document.querySelector(`.cb_${memId}[data-code="${c}"]`);
            if (cb) cb.checked = mDraft.checks[idx];
        });
        const nt = document.getElementById(`note_${memId}`);
        if (nt) nt.value = mDraft.note;
    });
}

// [åŠŸèƒ½] ä¸€éµå…¨é¸
function selectAll(memCode, teamKey) {
    document.querySelectorAll(`.cb_${memCode}`).forEach(cb => cb.checked = true);
    saveProgress(teamKey);
}

// [åŠŸèƒ½] æäº¤å…¨éšŠè³‡æ–™
async function finalSubmit() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey];
    const btn = document.getElementById('finalSubmitBtn');

    if (!confirm(`ç¢ºå®šæäº¤éšŠä¼ ${teamKey} å…± ${members.length} ä½è³½å“¡è³‡æ–™ï¼Ÿ`)) return;

    btn.disabled = true;
    btn.innerText = "æ­£åœ¨æäº¤...";

    const promises = members.map(m => {
        const params = new URLSearchParams(); // ä½¿ç”¨æœ€ç©©å®šçš„ URLSearchParams
        params.append(ENTRIES.staff, currentStaff);
        params.append(ENTRIES.teamId, teamKey);
        params.append(ENTRIES.memId, m.mem);
        ['A','B','C','D','E','F'].forEach(c => {
            const val = document.querySelector(`.cb_${m.mem}[data-code="${c}"]`).checked ? "OK" : "FAILED";
            params.append(ENTRIES['result'+c], val);
        });
        params.append(ENTRIES.note, document.getElementById(`note_${m.mem}`).value);

        return fetch(FORM_URL, { method: "POST", mode: "no-cors", body: params });
    });

    try {
        await Promise.all(promises);
        localStorage.removeItem(`draft_${teamKey}`); // æˆåŠŸå¾Œåˆªé™¤æš«å­˜
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.remove('hidden');
        window.scrollTo(0, 0);
    } catch (err) {
        alert("æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        btn.disabled = false;
        btn.innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
    }
}

// [åŠŸèƒ½] é‡ç½®å›åˆ°é¸éšŠç•«é¢
function resetToTeamSelection() {
    document.getElementById('teamNo').value = "";
    document.getElementById('memberListContainer').innerHTML = "";
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('finalSubmitBtn').disabled = false;
    document.getElementById('finalSubmitBtn').innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
}
</script>
</body>
</html>
