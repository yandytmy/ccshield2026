<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”è³½ç°½åˆ°ç³»çµ±</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#000;
  color:#fff;
  margin:0;
  text-align:center;
}
header{
  background:#111;
  padding:18px;
  font-size:26px;
  font-weight:bold;
}
input,button{
  width:92%;
  max-width:420px;
  padding:18px;
  margin:12px auto;
  font-size:24px;
  border-radius:12px;
  border:none;
}
.first-btn{background:#43A047;color:#fff}
.event-btn{background:#1E88E5;color:#fff}
.manual-btn{background:#F9A825;color:#000}
.back-btn{background:#555;color:#fff}

.confirm{
  font-size:36px;
  color:#4CAF50;
  margin-top:60px;
}
.fail{
  font-size:36px;
  color:#E53935;
  margin-top:60px;
}
.member-id{
  font-size:28px;
  margin-top:20px;
  color:#FFD54F;
}

.hidden{display:none}
#scanner{width:100%;max-width:420px;margin:auto}
</style>
</head>

<body>

<header id="header">ğŸ” å·¥ä½œäººå“¡ç™»å…¥</header>

<!-- å·¥ä½œäººå“¡ -->
<div id="staffPage" class="page">
  <input id="staffInput" placeholder="è¼¸å…¥å·¥ä½œäººå“¡åç¨±">
  <button class="event-btn" onclick="saveStaff()">é–‹å§‹</button>
</div>

<!-- é …ç›® -->
<div id="eventPage" class="page hidden">
  <button class="first-btn" onclick="selectEvent('é¦–æ¬¡å ±åˆ°')">â‘  é¦–æ¬¡å ±åˆ°</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®ä¸€')">â‘¡ é …ç›®ä¸€</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®äºŒ')">â‘¢ é …ç›®äºŒ</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®ä¸‰')">â‘£ é …ç›®ä¸‰</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®å››')">â‘¤ é …ç›®å››</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®äº”')">â‘¥ é …ç›®äº”</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®å…­')">â‘¦ é …ç›®å…­</button>
</div>

<!-- æƒæ -->
<div id="scanPage" class="page hidden">
  <div id="scanner"></div>
  <button class="manual-btn" onclick="openManual()">âœï¸ æ‰‹å‹•è¼¸å…¥</button>
  <button class="back-btn" onclick="backToEvent()">â¬… è¿”å›</button>
</div>

<!-- æ‰‹å‹• -->
<div id="manualPage" class="page hidden">
  <input id="teamNo" placeholder="éšŠè™Ÿï¼ˆ01â€“27ï¼‰" maxlength="2">
  <input id="memberNo" placeholder="éšŠå“¡ï¼ˆAâ€“Iï¼‰" maxlength="1">
  <button class="event-btn" onclick="submitManual()">æäº¤</button>
  <button class="back-btn" onclick="backToScan()">â¬… è¿”å›ç›¸æ©Ÿ</button>
</div>

<!-- âœ… æˆåŠŸ -->
<div id="successPage" class="page hidden">
  <div class="confirm">âœ… ç°½åˆ°æˆåŠŸ</div>
  <div id="successMember" class="member-id"></div>
</div>

<!-- âŒ å¤±æ•— -->
<div id="failPage" class="page hidden">
  <div class="fail">âŒ ç°½åˆ°å¤±æ•—</div>
  <div class="member-id">QR å…§å®¹ç„¡æ•ˆ</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// ========== Google Form ==========
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLSfb9TdBGH6aGtpX1chUArd-61hNR2QSOjyZ55_MJkReu4BZCQ/formResponse";
const ENTRY_MEMBER="entry.440560781";
const ENTRY_EVENT="entry.722246826";
const ENTRY_STAFF="entry.1290533017";
const ENTRY_DEVICE="entry.389796138";
// =================================

let staff="", eventName="";
let qr=null, scanning=false;
let device="DEV-"+Math.random().toString(36).substr(2,6).toUpperCase();

// âœ… åˆæ³• ID regex
const MEMBER_REGEX=/^(0[1-9]|1[0-9]|2[0-7])[A-I]$/;

function show(id){
 document.querySelectorAll(".page")
   .forEach(p=>p.classList.add("hidden"));
 document.getElementById(id)
   .classList.remove("hidden");
}

function vibrate(ms=100){
 if(navigator.vibrate) navigator.vibrate(ms);
}

function saveStaff(){
 staff=staffInput.value.trim();
 if(!staff) return alert("è«‹è¼¸å…¥åç¨±");
 header.innerText="ğŸ“‹ é¸æ“‡é …ç›®";
 show("eventPage");
}

function selectEvent(e){
 eventName=e;
 header.innerText="ğŸ“· æƒæ QR";
 show("scanPage");
 setTimeout(startScanner,200);
}

function startScanner(){
 scanning=false;
 qr=new Html5Qrcode("scanner");
 qr.start(
   {facingMode:"environment"},
   {fps:10,qrbox:250},
   onScanSuccess
 );
}

// âœ… æƒææˆåŠŸï¼ˆå« checkingï¼‰
function onScanSuccess(raw){
 if(scanning) return;
 scanning=true;

 const id=raw.trim().toUpperCase();

 qr.stop().then(()=>{
   // âŒ æ ¼å¼éŒ¯èª¤
   if(!MEMBER_REGEX.test(id)){
     vibrate(200);
     show("failPage");
     setTimeout(()=>{
       show("scanPage");
       startScanner();
     },800);
     return;
   }

   // âœ… æ­£ç¢º
   submit(id);
   document.getElementById("successMember").innerText="æˆå“¡ IDï¼š" + id;
   vibrate(100);
   show("successPage");

   setTimeout(()=>{
     show("scanPage");
     startScanner();
   },800);
 });
}

function submit(memberId){
 const d=new FormData();
 d.append(ENTRY_MEMBER,memberId);
 d.append(ENTRY_EVENT,eventName);
 d.append(ENTRY_STAFF,staff);
 d.append(ENTRY_DEVICE,device);
 fetch(FORM_URL,{method:"POST",mode:"no-cors",body:d});
}

// âœ… æ‰‹å‹•è¼¸å…¥ï¼ˆåŒæ¨£ checkingï¼‰
function submitManual(){
 let team=teamNo.value.padStart(2,"0");
 let mem=memberNo.value.toUpperCase();
 let id=team+mem;

 if(!MEMBER_REGEX.test(id)) return alert("æˆå“¡ ID ç„¡æ•ˆ");

 submit(id);
 document.getElementById("successMember").innerText="æˆå“¡ IDï¼š" + id;
 vibrate(100);
 show("successPage");
 setTimeout(()=>show("manualPage"),800);
}

function openManual(){
 if(qr) qr.stop();
 header.innerText="âœï¸ æ‰‹å‹•è¼¸å…¥";
 show("manualPage");
}

function backToScan(){
 header.innerText="ğŸ“· æƒæ QR";
 show("scanPage");
 setTimeout(startScanner,200);
}

function backToEvent(){
 if(qr) qr.stop();
 header.innerText="ğŸ“‹ é¸æ“‡é …ç›®";
 show("eventPage");
}
</script>

</body>
</html>
